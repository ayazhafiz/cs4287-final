<!DOCTYPE html>
<head>
  <meta name="viewport" content="width=device-width" />
  <meta charset="UTF-8" />
  <meta name="description" content="RCE Playground" />
  <title>Playground</title>

  <link rel="stylesheet" href="https://unpkg.com/@primer/css/dist/primer.css" />
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .h100 {
      height: 100%;
    }
    #playground {
      overflow: hidden;
    }
    /* Ansi -> HTML styles for use in coloring error messages. */
    .ansi-black-fg {
      color: #282c34;
    }
    .ansi-red-fg {
      color: #e06c75;
    }
    .ansi-green-fg {
      color: #73cc32;
    }
    .ansi-yellow-fg {
      color: #d19a66;
    }
    .ansi-blue-fg {
      color: #61afef;
    }
    .ansi-magenta-fg {
      color: #c678dd;
    }
    .ansi-cyan-fg {
      color: #56b6c2;
    }
    .ansi-white-fg {
      color: #abb2bf;
    }
    .ansi-bright-black-fg {
      color: #5c6370;
    }
    .ansi-bright-red-fg {
      color: #e06c75;
    }
    .ansi-bright-green-fg {
      color: #73cc32;
    }
    .ansi-bright-yellow-fg {
      color: #d19a66;
    }
    .ansi-bright-blue-fg {
      color: #61afef;
    }
    .ansi-bright-magenta-fg {
      color: #c678dd;
    }
    .ansi-bright-cyan-fg {
      color: #56b6c2;
    }
    .ansi-bright-white-fg {
      color: #ffffff;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ansi_up@4.0.4/ansi_up.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/loader.min.js"></script>
</head>

<body>
  <article id="app" class="markdown-body h100">
    <div class="d-flex flex-row flex-justify-around h100">
      <div class="col-5 float-left p-6 h100">
        <div class="form-group d-flex flex-row flex-justify-between">
          <div class="d-flex flex-row">
            <select class="form-select" v-model="language" v-on:change="changeLanguage">
              {% raw %}
              <option v-for="option in languageOptions" v-bind:value="option">{{ option }}</option>
              {% endraw %}
            </select>

            <details class="details-reset position-relative ml-2 mb-0">
              <summary class="btn btn-outline" v-on:click="getDescription">info</summary>
              <div class="Popover right-0 left-0">
                <div
                  class="Popover-message Popover-message--large Popover-message--top-left p-4 mt-2 Box box-shadow-large"
                >
                  <description :result="descriptionResult"></description>
                </div>
              </div>
            </details>
          </div>

          <button type="submit" class="btn btn-md btn-primary" v-on:click="run">Run</button>
        </div>

        <!-- TODO: set this automatically -->
        <div id="playground" style="height: 90%"></div>
      </div>
      <div class="col-5 float-left m-6" id="output">
        <h1>Results</h1>
        <results :result="executionResult"></results>
      </div>
    </div>
  </article>
</body>

<script>
  // TODO: make this an injected variable
  const RCE_ADDR = "http://127.0.0.1:8080";
  const LANGUAGE_TEMPLATES = {
    python: `print("Hello, world!")`,
    javascript: `console.log("Hello, world!");`,
    cpp: `
#include <iostream>

int main() {
  std::cout << "Hello, world!\\n";
}`.trim(),
    rust: `
fn main() {
    println!("Hello, world!");
}`.trim(),
  };
  const DEFAULT_LANGUAGE = "python";

  require.config({ paths: { vs: "https://unpkg.com/monaco-editor@0.21.2/min/vs" } });
  window.MonacoEnvironment = { getWorkerUrl: () => proxy };

  const proxy = URL.createObjectURL(
    new Blob(
      [
        `
  	self.MonacoEnvironment = { baseUrl: 'https://unpkg.com/monaco-editor@0.21.2/min/' };
  	importScripts('https://unpkg.com/monaco-editor@0.21.2/min/vs/base/worker/workerMain.js');`,
      ],
      { type: "text/javascript" }
    )
  );

  const $ = document.querySelector.bind(document);

  require(["vs/editor/editor.main"], function () {
    editor = monaco.editor.create($("#playground"), {
      value: LANGUAGE_TEMPLATES[DEFAULT_LANGUAGE],
      language: DEFAULT_LANGUAGE,
      theme: "vs-dark",
      fontSize: "15px",
      padding: { top: "20px" },
    });
  });

  const ansi = new AnsiUp();
  ansi.use_classes = true;

  const ExecutionResult = {
    loading: () => {
      return { loading: true };
    },
    success: (exitCode, stdout, stderr) => {
      return { success: true, exitCode, stdout, stderr };
    },
    failure: () => {
      return { failure: true };
    },
  };

  Vue.component("results", {
    props: ["result"],
    template: `
      {% raw %}
      <div v-if="result.loading">
        <h2><span>Loading</span><span class="AnimatedEllipsis"></span></h2>
      </div>
      <div v-else>
        <div v-if="result.success">
          <h2>exit code</h2>
          <pre>{{ result.exitCode }}</pre>
          <h2>stdout</h2>
          <component :is="stdoutHtml"></component>
          <h2>stderr</h2>
          <component :is="stderrHtml"></component>
        </div>
        <div v-else>
          <h2>Loading Error</h2>
          Please try again.
        </div>
      </div>
      {% endraw %}
    `,
    computed: {
      stdoutHtml() {
        const stdout = ansi.ansi_to_html(this.result.stdout);
        return {
          template: `<pre class="inner">${stdout}</pre>`,
        };
      },
      stderrHtml() {
        const stderr = ansi.ansi_to_html(this.result.stderr);
        return {
          template: `<pre class="inner">${stderr}</pre>`,
        };
      },
    },
  });

  const DescriptionResult = {
    loading: () => {
      return { loading: true };
    },
    success: (languageDescription, osVersion, packages) => {
      return { success: true, languageDescription, osVersion, packages };
    },
    failure: () => {
      return { failure: true };
    },
  };

  Vue.component("description", {
    props: ["result"],
    template: `
      {% raw %}
      <div v-if="result.loading">
        <span>Loading</span><span class="AnimatedEllipsis"></span>
      </div>
      <div v-else>
        <div v-if="result.success">
          <b>{{ result.languageDescription }} - {{ result.osVersion }}</b>
          <pre class="mb-0">{{ result.packages.join('\\n') }}</pre>
        </div>
        <div v-else>
          <h2>Loading Error</h2>
          Please try again.
        </div>
      </div>
      {% endraw %}
    `,
  });

  new Vue({
    el: "#app",
    data: {
      language: DEFAULT_LANGUAGE,
      lastLanguage: DEFAULT_LANGUAGE,
      languageOptions: Object.keys(LANGUAGE_TEMPLATES),
      executionResult: ExecutionResult.success("", "", ""),
      descriptionResult: DescriptionResult.success("", "", []),
    },
    methods: {
      async run() {
        this.executionResult = ExecutionResult.loading();
        await axios
          .post("/api/rce", {
            lang: this.language,
            code: editor.getValue(),
          })
          .then((result) => {
            const {
              data: { exitcode, stdout, stderr },
            } = result;
            this.executionResult = ExecutionResult.success(exitcode, stdout, stderr);
          })
          .catch((e) => {
            console.error(e);
            this.executionResult = ExecutionResult.failure();
          });
      },

      async getDescription() {
        this.descriptionResult = DescriptionResult.loading();
        await axios
          .get(`/api/describe/${this.language}`)
          .then((result) => {
            const {
              data: { description, ubuntu, packages },
            } = result;
            this.descriptionResult = DescriptionResult.success(
              description,
              `Ubuntu ${ubuntu}`,
              packages
            );
          })
          .catch((e) => {
            console.error(e);
            this.descriptionResult = DescriptionResult.failure();
          });
      },

      changeLanguage() {
        LANGUAGE_TEMPLATES[this.lastLanguage] = editor.getValue();
        editor.setValue(LANGUAGE_TEMPLATES[this.language]);
        monaco.editor.setModelLanguage(editor.getModel(), this.language);
        this.lastLanguage = this.language;
      },
    },
  });
</script>
